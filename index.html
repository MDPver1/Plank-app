<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Plank Timer</title>
<style>
  :root{--bg:#0e0e0e;--fg:#fff;--accent:#0a84ff;--stop:#ff3b30}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--fg);
    font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif;
    display:flex;flex-direction:column;align-items:center;justify-content:center;gap:22px
  }

  /* верхний баннер сообщений (во время работы скрыт) */
  #msgTop{position:fixed;top:20px;left:0;right:0;text-align:center;
    font-size:64px;font-weight:800;opacity:0;transition:.2s}
  #msgTop.show{opacity:1}

  /* стартовые элементы */
  .row{display:flex;align-items:center;gap:22px}
  #big{font-size:96px;min-width:160px;text-align:center;margin:0}
  .btn-outline{
    width:64px;height:64px;border-radius:14px;border:2px solid #fff;background:transparent;
    color:#fff;font-size:34px;display:flex;align-items:center;justify-content:center
  }
  .btn{border:0;border-radius:12px;padding:12px 18px;font-size:18px;color:#fff;background:var(--accent)}
  .btn.stop{background:var(--stop)}
  .hidden{display:none !important}
  .hint{opacity:.7}

  /* сцена таймера с кругом */
  #stage{width:min(92vw,92vh);aspect-ratio:1;border-radius:50%;
    position:relative;display:none;align-items:center;justify-content:center}
  #stage.show{display:flex}
  .center{
    position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    font-weight:900;font-size:min(22vw,22vh);line-height:1
  }
  .below{position:absolute;bottom:-64px}

  svg{width:100%;height:100%;transform:rotate(-90deg)} /* чтобы 0° был сверху */
  circle.track{fill:none;stroke:#242424;stroke-width:14}
  circle.progress{fill:none;stroke-width:14;stroke-linecap:round}

  /* тёмный оверлей прекаунта */
  #overlay{
    position:fixed;inset:0;background:#000;display:none;align-items:center;justify-content:center;z-index:10
  }
  #overlay.show{display:flex}
  #pre{font-size:min(22vw,22vh);font-weight:900;color:#fff}
</style>
</head>
<body>

  <!-- стартовый экран -->
  <div id="startUI">
    <div class="row">
      <button id="minus" class="btn-outline">−</button>
      <h1 id="big">30</h1>
      <button id="plus"  class="btn-outline">+</button>
    </div>
    <button id="startBtn" class="btn">Start</button>
    <div id="hint" class="hint">Шаг ±10 сек</div>
  </div>

  <!-- сцена отсчёта: круг + число/сообщение -->
  <div id="stage">
    <svg viewBox="0 0 100 100">
      <defs>
        <!-- градиент по окружности: верх — переход -->
        <linearGradient id="g" x1="0.5" y1="0" x2="0.5" y2="1">
          <stop offset="0%"  stop-color="#ff3b30"/>  <!-- верх (красный) -->
          <stop offset="100%" stop-color="#34c759"/> <!-- низ (зелёный) -->
        </linearGradient>
      </defs>
      <!-- серый фон круга -->
      <circle class="track" cx="50" cy="50" r="44"></circle>
      <!-- прогресс -->
      <circle id="arc" class="progress" cx="50" cy="50" r="44" stroke="url(#g)"></circle>
    </svg>
    <div id="center" class="center">30</div>
    <button id="stopBtn" class="btn stop below">Stop</button>
  </div>

  <!-- сообщение «Well done!» сверху (используем и после финиша) -->
  <div id="msgTop">Well done!</div>

  <!-- финишный экран -->
  <div id="finishUI" class="hidden">
    <div id="finishText" style="font-size:96px;font-weight:900;text-align:center">Well done!</div>
    <button id="againBtn" class="btn" style="margin-top:10px">Again</button>
  </div>

  <!-- оверлей прекаунта -->
  <div id="overlay"><div id="pre">Ready!</div></div>

<script>
/* ---------- звук ---------- */
let ac=null;
function ensureAudio(){
  try{
    const AC=window.AudioContext||window.webkitAudioContext;
    if(!ac) ac=new AC();
    if(ac.state==='suspended') ac.resume();
  }catch(e){}
}
function beep(ms=150,f=1100,vol=0.07){
  if(!ac) return;
  const o=ac.createOscillator(), g=ac.createGain();
  o.type='sine'; o.frequency.value=f; g.gain.value=vol;
  o.connect(g); g.connect(ac.destination);
  const t0=ac.currentTime; o.start(t0); o.stop(t0+ms/1000);
  setTimeout(()=>{o.disconnect();g.disconnect();},ms+50);
}

/* ---------- элементы ---------- */
const startUI = document.getElementById('startUI');
const stage    = document.getElementById('stage');
const finishUI = document.getElementById('finishUI');
const center   = document.getElementById('center');
const big      = document.getElementById('big');
const minusBtn = document.getElementById('minus');
const plusBtn  = document.getElementById('plus');
const startBtn = document.getElementById('startBtn');
const stopBtn  = document.getElementById('stopBtn');
const againBtn = document.getElementById('againBtn');
const msgTop   = document.getElementById('msgTop');

const overlay  = document.getElementById('overlay');
const pre      = document.getElementById('pre');

const arc      = document.getElementById('arc');
const R=44, C=2*Math.PI*R;        // окружность для штриха
arc.style.strokeDasharray = String(C);
arc.style.strokeDashoffset = "0";

/* ---------- модель ---------- */
let base=30;        // длительность по умолчанию
let total=base;     // текущая длительность (сек)
let left=0;         // осталось (сек)
let tickInt=null;   // setInterval

function updateBig(){ big.textContent = String(total); }
updateBig();

minusBtn.onclick=()=>{ if(tickInt) return; total=Math.max(10,total-10); updateBig(); };
plusBtn.onclick =()=>{ if(tickInt) return; total+=10; updateBig();  };

startBtn.onclick=()=>{ if(tickInt) return; ensureAudio(); precount(()=>start()); };
stopBtn.onclick =resetAll;
againBtn.onclick=resetAll;

/* ---------- прекаунт 3с: полностью перекрывает экран ---------- */
function precount(done){
  // скрываем всё подложкой
  overlay.classList.add('show');
  const words=['Ready!','Set!','Go!'];
  let i=0;
  const step=()=>{
    pre.textContent=words[i];
    beep(120, i<2?950:1200);
    i++;
    if(i<words.length) setTimeout(step,1000);
    else setTimeout(()=>{ overlay.classList.remove('show'); done(); },600);
  };
  step();
}

/* ---------- запуск таймера и рендера круга ---------- */
function start(){
  // переключаем UI
  startUI.classList.add('hidden');
  finishUI.classList.add('hidden');
  msgTop.classList.remove('show');
  stage.classList.add('show');

  left=total;
  renderCircle(1);                   // полный круг
  renderCenter(left);

  // тики
  let tick=0;
  tickInt=setInterval(()=>{
    left--; tick++;
    renderCenter(Math.max(left,0));
    renderCircle(left/total);
    if(left<=0){
      clearInterval(tickInt); tickInt=null;
      finish();
      return;
    }
    if(tick%10===0) beep(150,1100);  // каждые 10 секунд
  },1000);
}

/* круг — уменьшаем длину штриха */
function renderCircle(frac){
  const clamped=Math.max(0,Math.min(1,frac));
  arc.style.strokeDashoffset = String(C*(1-clamped));
}

/* что показывать внутри круга */
function renderCenter(value){
  center.textContent = String(value);
}

/* ---------- завершение ---------- */
function finish(){
  // тройной такой же бип
  beep(150,1100); setTimeout(()=>beep(150,1100),220); setTimeout(()=>beep(150,1100),440);

  // надпись сверху не нужна; всё в центре и кнопка Again внизу
  center.textContent='Well done!';
  stopBtn.classList.add('hidden');     // убираем stop
  setTimeout(()=>{
    stage.classList.remove('show');
    finishUI.classList.remove('hidden');
  },600);
}

/* ---------- сброс к старту ---------- */
function resetAll(){
  if(tickInt){ clearInterval(tickInt); tickInt=null; }
  total = base;
  updateBig();
  stage.classList.remove('show');
  finishUI.classList.add('hidden');
  stopBtn.classList.remove('hidden');
  msgTop.classList.remove('show');
  startUI.classList.remove('hidden');
}
</script>
</body>
</html>
